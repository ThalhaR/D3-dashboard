<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> d3_load_csv_json.html</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.js"></script>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.7.0/css/all.css' integrity='sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ' crossorigin='anonymous'>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://momentjs.com/downloads/moment-with-locales.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <img id="logo" src="logo.png" height="60">
    <img id="iris" src="price.jpg" height="60">
    <div class="flex-child">

        <svg id="svg5">
            <foreignobject class="node" x="1vw" y="3vh" width="18vw" height="100">
                    <i class="fa fa-user" style="font-size:48px;color:white"></i>
            </foreignobject>
        <foreignobject class="node" x="60px" y="1vh" width="12.1vw" height="100">

            <p align="left">
                    <font style="font-size: 20px" face="Calibri" color="white"><span
                        id="number_admission_month"></span> Patients</font>
                        <br>
                <font style="font-size: 15px" face="Calibri" color="white"> Total patients admitted

                </font>
            </p>
        </foreignobject>

        </svg>
        <svg id="svg6">
            <foreignobject class="node" x="1vw" y="3vh" width="18vw" height="100">
                    <i class="fa fa-line-chart",aria-hidden="true" style="font-size:48px;color:white"></i>
            </foreignobject>
        <foreignobject class="node" x="75px" y="1vh" width="12.1vw" height="100">

            <p align="left">
                    <font style="font-size: 20px" face="Calibri" color="white"><span
                        id="mean_admissions"></span> Patients</font>
                        <br>
                <font style="font-size: 15px" face="Calibri" color="white"> Mean monthly admissions

                </font>
            </p>
        </foreignobject>
        </svg>
        <svg id="svg7">
                <foreignobject class="node" x="1vw" y="3vh" width="18vw" height="100">
                        <i class="fa fa-calendar" style="font-size:48px;color:white"></i>
                </foreignobject>
            <foreignobject class="node" x="65px" y="1vh" width="11.9vw" height="100">

                <p align="left">
                        <font style="font-size: 20px" face="Calibri" color="white"><span
                            id="lenght_of_stay"></span> Days</font>
                            <br>
                    <font style="font-size: 15px" face="Calibri" color="white"> Mean length of stay

                    </font>
                </p>
            </foreignobject>
        </svg>

        <svg id="svg8">
            <foreignobject class="node" x="1vw" y="3.7vh" width="18vw" height="100">
                <i class='fas fa-procedures' style='font-size:42px;color:white'></i>

            </foreignobject>
        <foreignobject class="node" x="75px" y="0.0vh" width="11.9vw" height="100">

            <p align="left">
                    <font style="font-size: 20px" face="Calibri" color="white">1 : <span id="unplanned"></span> </font>
                        <br>
                <font style="font-size: 15px" face="Calibri" color="white"> Admission type <br> Planned : Unplanned

                </font>
            </p>
        </foreignobject>
    </svg>

    </div>
    <div>
        <svg id="svg1">
            <foreignobject class="node" x="0vw" y="-1.3vh" width="32vw" height="100">
                <p align="center">
                    <font style="font-size: 22px" face="Calibri" color="#36454f"><b> Admission information </b></font>
                </p>

            </foreignobject>
            <foreignobject class="node" x="1vw" y="5vh" width="30vw" height="100vh">
                <p>
                    <font color="#36454f" style="font-size: 17px" face="Calibri">
                         Route to admission
                    </font>
                </p>
            </foreignobject>
            <foreignobject  class="node" x="1vw" y="33vh" width="30vw" height=" 100">
                <p>
                    <font id="ms" style="font-size: 17px" face="Calibri" >
                        Primary system <i>click the bar for details</i>
                        </font>
                </p>
            </foreignobject>
            <foreignobject class="node" x="1vw" y="33vh" width="30vw" height=" 100">
                <p>
                    <font id="md" style="font-size: 17px" face="Calibri">
                        Reasons for admission <i>click the bar for details</i>
                    </font>
                </p>
            </foreignobject>
        </svg>
        <svg id="svg2">
            <foreignobject class="node" x="0vw" y="-1.3vh" width="32vw" height="80">
                <p align="center">
                    <font style="font-size: 22px" face="Calibri" color="#36454f"><b> Acuity </b></font>
                </p>

            </foreignobject>
            <foreignobject class="node" x="1vw" y="5vh" width="29vw" height="80vh">
                <p>
                    <font color="#36454f" style="font-size: 17px" face="Calibri">
                        Mechanically ventilated on admission= <span id="mechanically_ventilated"></span> %
                        <br>
                        <br>

                        Cardiovascular support on admission = <span id="cardiovascular_support"></span>%

                        <br>
                        <br>

                        
                        Antibiotics on admission = <span id="antibiotics"></span> % 

                        <br>
                        <br>

                        Mean APACHE score [planned] = <span id="ap"></span> (<span id="sp"></span>)

                        <br>
                        <br>

                        Mean APACHE score [unplanned] = <span id="au"></span> (<span id="su"></span>)

                        <br>
                        <br>

                        Tracheostomy performed = <span id="trackeostomy"></span>
                    </font>
                </p>
            </foreignobject>
        </svg>
        <svg id="svg3">
            <foreignobject class="node" x="0vw" y="-1.3vh" width="32vw" height="100">
                <p align="center">
                    <font style="font-size: 22px" face="Calibri" color="#36454f"><b> Outcome </b></font>
                </p>

            </foreignobject>
            <foreignobject class="node" x="1vw" y="3.5vh" width="30vw" height="100vh">
                <p>
                    <font color="#36454f" style="font-size: 17px" face="Calibri">Discharge status

                    </font>
                </p>
            </foreignobject>
        </svg>
        <svg id="svg4">
            <foreignobject class="node" x="0vw" y="-1.3vh" width="32vw" height="100">
                <p align="center">
                    <font style="font-size: 22px" face="Calibri" color="#36454f"><b> Quality indicators </b></font>
                </p>

            </foreignobject>
            <foreignobject class="node" x="1vw" y="5vh" width="30vw" height="100vh">
                <p>
                    <font color="#36454f" style="font-size: 17px" face="Calibri">
                        Overall patient satisfaction = <span id="patient_satisfation"></span>
                        <br>
                        <br>
                        Mean number of days on antibiotics = <span id="duration_on_antibiotics"></span>
                        <br>
                        <br>
                        Mean number of days mechanically ventilated = <span id="days_mechanically_ventilated"></span>
                        <br>
                        <br>
                        Quality of life (EQ-5D)
                </font>


                </p>
            </foreignobject>
        </svg>

    </div>
    <svg id="anti"></svg>
    <div id="chart" style="height:0px; width:0px">
        <div class="innerCont" style="overflow: auto; top:57%; left: 5px; height:42% ; Width:32% ;position: absolute;overflow: hidden;"></div>
    </div>
    <div id="filter1">
            <input type="month" id = "start1" min = "2018-11" max ="max" value ="value">
            <button id="button1" onclick=filter()>Select month</button>
        </div>

    <button id="button2">Back</button>
    </head>

    <body>
    <script>// pass filter date</script>
    <script>
    function a(){
        if(document.getElementById("#anti").style.opacity === 0){
            document.getElementById("#anti").style.opacity === 1
        }
        else {
            document.getElementById("#anti").style.opacity === 0
        }
    }

    function filter1() {
              var y =  document.getElementById('start1').value;
              return y
            }
    function filter(){
    var y = filter1()
    var date = new FormData();
    date.append('month',y);

    var xhr = new XMLHttpRequest();
    xhr.open('POST', "http://127.0.0.1:5000/vizdata", true);
    xhr.onload = function () {
        if(xhr.readyState == 4 && xhr.status == 200) {
            d1 = JSON.parse(xhr.responseText);
            loaddata(d1)}
        else{
            alert("No data for this month")
        }
        console.log(this.responseText);
    };
    xhr.send(date);


    }
    </script>

    <script>// load data</script>
    <script>

        function loaddata(d1) {
            $.getJSON('http://127.0.0.1:5000/vizdata', function (d) {

                //for text
                if (d1 !== undefined) {
                        data = d1
                    } else {
                        data = d
                        try {  discharge_status = JSON.parse(data.discharge_status)
                        TimeBarChart(discharge_status)
                        
                        values = String(data.values)
                        
                        document.getElementById("start1").value = values;
                    } catch (err) {}


                    }
                try {
                mean_admissions = data.avg_monthly_admission
                months_admissions = data.admission_month
                lenght_of_stay = data.lenght_of_stay
                unplanned = data.admission_type
                mechanically_ventilated = data.mechanically_ventilated.per
                cardiovascular_support = data.cardiovascular_support.per
                antibiotics = data.use_of_antibiotics.per
                trackeostomy = data.trackeostomy
                satisfaction_score = data.saq_score
                duration_on_antibiotics = data.time_on_antibiotics
                days_mechanically_ventilated = data.mean_days_mechanically_ventilated
                sp = data.APACHE.stand_planned
                su = data.APACHE.stand_unplanned
                p = data.APACHE.APACHE_planned
                u = data.APACHE.APACHE_unplanned
                values = String(data.values)

                // charts data
                diagnosis = JSON.parse(data.diagnosis)
                non = data.diagnosis_type.non
                post = data.diagnosis_type.post
                patient_satisfation = data.patient_satisfation
                discharge_status = JSON.parse(data.discharge_status)
                drill = JSON.parse(data.dril)
                

                // exporting to span
                document.getElementById("mean_admissions").innerHTML = mean_admissions
                document.getElementById("lenght_of_stay").innerHTML = lenght_of_stay
                document.getElementById("unplanned").innerHTML = unplanned
                document.getElementById("mechanically_ventilated").innerHTML = mechanically_ventilated
                document.getElementById("cardiovascular_support").innerHTML = cardiovascular_support
                document.getElementById("antibiotics").innerHTML = antibiotics
                document.getElementById("trackeostomy").innerHTML = trackeostomy
                document.getElementById("duration_on_antibiotics").innerHTML = duration_on_antibiotics
                document.getElementById("number_admission_month").innerHTML = months_admissions
                document.getElementById("days_mechanically_ventilated").innerHTML = days_mechanically_ventilated
                document.getElementById("start1").max = values
                document.getElementById("patient_satisfation").innerHTML = patient_satisfation
                document.getElementById("su").innerHTML = su
                document.getElementById("sp").innerHTML = sp
                document.getElementById("ap").innerHTML = p
                document.getElementById("au").innerHTML = u
                // document.getAnimations("APACHE").innerHTML = APACHE;


                // Call chart

                pie(post,non)
                // diagnosisChart(diagnosis)
                dia(drill)
                guage(satisfaction_score/100)
                }
                catch (err) {}

            });
        }

        data = loaddata()
    </script>

    <script> // pie chart Post/Non</script>
    <script>
        function pie(x, y) {
            d3.select("#mypiechart").remove();

            var data = [parseInt(x), parseInt(y)];

            var width = 150,
                height = 150,
                radius = Math.min(width, height) / 2;

            var color = d3.scaleOrdinal()
                .range(["#43A9C7" ,"#5EDBDF"]);

            var arc = d3.arc()
                .outerRadius(radius - 10)
                .innerRadius(25);

            var labelArc = d3.arc()
                .outerRadius(radius - 40)
                .innerRadius(radius - 30);

            var pie = d3.pie()
                .sort(null)
                .value(function (d) { return d; });

            var svg = d3.select("#svg1")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width * 0.75 + "," + 150+ ")");


            var g = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            g.append("path")
                .attr("d", arc)
                .style("fill", function (d) { return color(d.data); })
                .attr("id", "mypiechart");

            g.append("text")
                .attr("transform", function (d) { return "translate(" + (labelArc.centroid(d)) + ")"; })
                .attr("dy", ".3em")
                .attr("dx", "-0.85em")
                .text(function (d) { return d.data + "%"; })
                .style("font-size", 12)
                .style('fill', '#4B4C47')
                ;
        }

    </script>

    <script>// legend post/non </script>
    <ul class="nonpost">
        <li><span class="non_operative"></span>
            <font style="font-size: 16px" face="Calibri" color="#4B4C47">Non operative</font>
        </li>
        <li><span class="post_operative"></span>
            <font style="font-size: 16px" face="Calibri" color="#4B4C47">Post operative</font>
        </li>
    </ul>

    <script>// dicharge bar chart</script>
    <script>
        function TimeBarChart(data) {
            var initStackedBarChart = {
                draw: function (config) {
                    me = this,
                        domEle = config.element,
                        stackKey = config.key,
                        data = config.data,
                        margin = { top: 80, right: window.innerWidth * 0.12, bottom: 30, left: 50 },
                        parseDate = d3.timeParse("%Y-%m-%dT%H:%M:%SZ"),
                        width = window.innerWidth * 0.27;
                    height = 105;
                    xScale = d3.scaleBand().range([0, width]).padding(0.1),
                        yScale = d3.scaleLinear().range([height, 0]),
                        color = d3.scaleOrdinal() // D3 Version 4
                            .domain(["New York", "Austin"])
                            .range(["#5EDBDF", "#43A9C7"]);
                    xAxis = d3.axisBottom(xScale).tickFormat(d3.timeFormat("%b %Y")),
                        yAxis = d3.axisLeft(yScale),
                        svg = d3.select("#svg3")
                            .attr("width", width + margin.left + margin.right)
                            .attr("height", height + margin.top + margin.bottom)
                            .append("g")
                            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    var stack = d3.stack()
                        .keys(stackKey)
                        .order(d3.stackOrderNone)
                        .offset(d3.stackOffsetNone);

                    var layers = stack(data);
                    data.sort(function (a, b) { return b.total - a.total; });
                    xScale.domain(data.map(function (d) { return parseDate(d.dateofdischarge); }));
                    yScale.domain([0, d3.max(layers[layers.length - 1], function (d) { return d[0] + d[1]; })]).nice();

                    var layer = svg.selectAll(".layer")
                        .data(layers)
                        .enter().append("g")
                        .attr("class", "layer")
                        .style("fill", function (d, i) { return color(i); });


                    layer.selectAll("rect")
                        .data(function (d) { return d; })
                        .enter().append("rect")
                        .attr("x", function (d) { return xScale(parseDate(d.data.dateofdischarge)); })
                        .attr("y", function (d) { return yScale(d[1]); })
                        .attr("height", function (d) { return yScale(d[0]) - yScale(d[1]); })
                        .attr("width", xScale.bandwidth());

                    svg.append("g")
                        .attr("class", "axis axis--x")
                        .attr("transform", "translate(0," + (height ) + ")")
                        .call(xAxis)
                        .selectAll("text")
                        .style('fill', '#36454f')
                        .attr("x", 30)
                        .attr("dy", ".35em")
                        .attr("transform", "rotate(50)")
                        .attr("id", "mybarchart");


                    svg.append("g")
                        .attr("class", "axis axis--y")
                        .attr("transform", "translate(0,0)")
                        .call(yAxis)
                        .selectAll("text")
                        .style('fill', '#36454f');
                }
            }
            var data = data
            var key = ["Alive", "Dead"];
            initStackedBarChart.draw({
                data: data,
                key: key,
                element: 'stacked-bar'
            });

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", 0 - (height / 2))
                .attr("dy", "-2.6em")
                .style("text-anchor", "middle")
                .style("font-size", 12)
                .style('fill', '#36454f')
                .style('font-family',"sans-serif")
                .text("Number of patients");
        }
    </script>

    <script>// discharge legend</script>
    <ul class="legend">
            <li><span class="alive"></span><font style="font-size: 16px" face = "Calibri" color = "#4B4C47">Alive</font> </li>
            <li><span class="dead"></span> <font style="font-size: 16px" face = "Calibri" color = "#4B4C47">Dead</font></li>
        </ul>

    <script>// diagnosis bar chart</script>
    <script>
        function diagnosisChart(data) {
            d3.select("#svgs").remove();


            var margin = { top: 305, right: window.innerWidth * 0.01, bottom: 30, left: window.innerWidth * 0.03 },
                width = window.innerWidth * 0.25;
            height = 120;


            // set the ranges
            var x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);
            var y = d3.scaleLinear()
                .range([height, 0]);



            // append the svgs object to the body of the page
            // append a 'group' element to 'svgs'
            // moves the 'group' element to the top left margin
            var svgs = d3.select("#svg1")
                .append("g")
                .attr("transform","translate(" + margin.left + "," + margin.top + ")")
                .attr("id", "svgs");


            // get the data
            var data = data

            // format the data
            data.forEach(function (d) {
                d.sales = +d.num;
            });

            // Scale the range of the data in the domains
            x.domain(data.map(function (d) { return d.Diagnosis; }));
            y.domain([0, d3.max(data, function (d) { return d.sales; })]);

            // append the rectangles for the bar chart
            svgs.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function (d) { return x(d.Diagnosis); })
                .attr("width", x.bandwidth())
                .attr("y", function (d) { return y(d.sales); })
                .attr("height", function (d) { return height - y(d.sales); });

            // add the x Axis
            svgs.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style('fill', '#36454f')
                .attr("y", 0)
                .attr("x", 45)
                .attr("transform", "rotate(50)");



            // add the y Axis
            svgs.append("g")
                .call(d3.axisLeft(y))
                .selectAll("text")
                .style('fill', '#36454f');

            svgs.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", 0 - (height / 2))
                .attr("dy", "-2.6em")
                .style("text-anchor", "middle")
                .style("font-size", 12)
                .style('fill', '#36454f')
                .style('font-family',"sans-serif")
                .text("Number of patients");

        }

    </script>
    <script>
   function dia(data){
    var salesData;
    var truncLengh = 30;
    $(document).ready(function () {
        Plot();
    });
    function Plot() {
        TransformChartData(chartData, chartOptions);
        BuildBar("chart", chartData, chartOptions);
    }

    function op0() {
        document.getElementById("md").style.opacity = "1";
        document.getElementById("ms").style.opacity = "0";
        document.getElementById("button2").style.opacity = "1";

        }

    function op1(y) {
        document.getElementById("md").style.opacity = "0";
        document.getElementById("ms").style.opacity = "1";    
        document.getElementById("button2").style.opacity = "0";
        }


    function BuildBar(id, chartData, options, level) {
        d3.selectAll("#" + id + " svg").remove();
        chart = d3.select("#" + id + " .innerCont");

        var margin = { top: 50, right: 50, bottom: 100, left: 50 },
        width = window.innerWidth * 0.26
        height = 165
        var xVarName;
        var yVarName = options[0].yaxis;

        if (level == 1) {
            xVarName = options[0].xaxisl1;
        }
        else {
            xVarName = options[0].xaxis;
        }

        var xAry = runningData.map(function (el) {
            return el[xVarName];
        });

        var yAry = runningData.map(function (el) {
            return el[yVarName];
        });

        var capAry = runningData.map(function (el) { return el.caption; });


        var x = d3.scaleBand().domain(xAry).rangeRound([0, width], .5);
        var y = d3.scaleLinear().domain([0, d3.max(runningData, function (d) { return d[yVarName]; })]).range([height, 0]);
        var rcolor = d3.scaleOrdinal().range(runningColors);

        chart = chart
                    .append("svg")  //append svg element inside #chart
                    .attr("width", width + margin.left + margin.right)    //set width
                    .attr("height", height + margin.top + margin.bottom);  //set height

        var bar = chart.selectAll("g")
                        .data(runningData)
                        .enter()
                        .append("g")
                        .attr("transform", function (d) {
                            return "translate(" + x(d[xVarName]) + ", 0)";
                        });

        var ctrtxt = 0;
        var xAxis = d3.axisBottom()
                    .scale(x)
                    .ticks(xAry.length)
                    .tickFormat(function (d) {
                        if (level == 0) {
                            var mapper = options[0].captions[0]
                            return mapper[d]
                        }
                        else {
                            var r = runningData[ctrtxt].caption;
                            ctrtxt += 1;
                            return r;
                        }
                    });

        var yAxis = d3.axisLeft()
                        .scale(y)
                        .ticks(10); //orient left because y-axis tick labels will appear on the left side of the axis.

        bar.append("rect")
            .attr("y", function (d) {
                return y(d.num) + margin.top - 15;
            })
            .attr("x", function (d) {
                return (margin.left + (x.bandwidth()) / 4);
            })
            .on("mouseenter", function (d) {
                d3.select(this)
                    .attr("stroke", "white")
                    .attr("stroke-width", 1)
                    .attr("y", function (d) {
                        return y(d.num) + margin.top - 20;
                    })
                    .attr("height", function (d) {
                        return height - y(d[yVarName]) + 5;
                    })
                    .attr("x", function (d) {
                        return (margin.left - 5 + (x.bandwidth()) / 4);
                    })
                    .attr("width", (x.bandwidth())/2 + 10)
                    .transition()
                    .duration(200);


            })
            .on("mouseleave", function (d) {
                d3.select(this)
                    .attr("stroke", "none")
                    .attr("y", function (d) {
                        return y(d[yVarName]) + margin.top - 15;
                    })
                    .attr("height", function (d) {
                        return height - y(d[yVarName]);
                    })
                    .attr("x", function (d) {
                        return (margin.left + (x.bandwidth()) / 4);
                    })
                    .attr("width", (x.bandwidth()) / 2)
                    .transition()
                    .duration(200);

            })
            .on("click", function (d) {
                if (this._listenToEvents) {
                    // Reset inmediatelly
                    // Change level on click if no transition has started
                    path.each(function () {
                        this._listenToEvents = false;
                    });
                }
                if (level == 1) {
                    d3.selectAll("#" + id + " svg").remove();
                    TransformChartData(chartData, options, 0, d[xVarName]);
                    BuildBar(id, chartData, options, 0);
                    op1();
                   
                }
                else {
                    op0();
                    var nonSortedChart = chartData.sort(function (a, b) {
                        return parseFloat(b[options[0].yaxis]) - parseFloat(a[options[0].yaxis])
                        d3.selectAll("#" + id + " svg").remove();

                    });
                    TransformChartData(nonSortedChart, options, 1, d[xVarName]);
                    BuildBar(id, nonSortedChart, options, 1);
                }
                $(document).ready(function () {
                $("#button2").click(function () {
                    d3.selectAll("#" + id + " svg").remove();
                    TransformChartData(chartData, options, 0, d[xVarName]);
                    BuildBar(id, chartData, options, 0);
                    op1();
                   
                });
            });

            });

       

        bar.selectAll("rect")
        .transition()
        .duration(1000)
        .attr("height", function (d) {
            return height - y(d[yVarName]);
        })
        .attr("width", (x.bandwidth()) / 2); //set width base on range on ordinal data;

        //setTimeout( 1000)
        bar.selectAll("rect").style("fill", function (d) {
            return rcolor(d[xVarName]);
        }),

        bar.append("svg:title")
            .text(function (d) {
                if (level == 1) {
                    return "Click to go back"}
                else {
                    return "Click to see diagnosis's for " +  d["title"];
                }
            });


        chart.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(" + margin.left + "," + (height + margin.top - 15) + ")")
            .call(xAxis)
            

            chart.select(".x.axis")
            .selectAll("text")
            .style("text-anchor", "start")
            .call(wrap,80)
            .attr("transform", " translate(5,5) rotate(45)")
            ;

        function wrap(text, width) {
            text.each(function() {
                var text = d3.select(this),
                    words = text.text().split(/\s+/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = text.attr("y"),
                    dy = parseFloat(text.attr("dy")),
                    tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y ).attr("dy", dy + "em");
                while (word = words.pop()) {
                line.push(word);
                tspan.text(line.join(" "));
                if (tspan.node().getComputedTextLength() > width) {
                    line.pop();
                    tspan.text(line.join(" "));
                    line = [word];
                    console.log(y)
                    tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                }
                }
            });
            }
        //.text("Year");

        chart.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + margin.left + "," + (margin.top - 15) + ")")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", 0 - (height / 2))
            .attr("dy", "-2.6em")
            .style("text-anchor", "middle")
            .style("font-size", 12)
            .style('fill', '#36454f')
            .style('font-family',"sans-serif")
            .text("Number of patients")
            .append("text")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "center");
        

    }

    function TransformChartData(chartData, opts, level, filter) {
        var result = [];
        var resultColors = [];
        var counter = 0;
        var hasMatch;
        var xVarName;
        var yVarName = opts[0].yaxis;

        if (level == 1) {
            xVarName = opts[0].xaxisl1;

            for (var i in chartData) {
                hasMatch = false;
                for (var index = 0; index < result.length; ++index) {
                    var data = result[index];

                    if ((data[xVarName] == chartData[i][xVarName]) && (chartData[i][opts[0].xaxis]) == filter) {
                        result[index][yVarName] = result[index][yVarName] + chartData[i][yVarName];
                        hasMatch = true;
                        break;
                    }

                }
                if ((hasMatch == false) && ((chartData[i][opts[0].xaxis]) == filter)) {
                    if (result.length < 9) {
                        ditem = {}
                        ditem[xVarName] = chartData[i][xVarName];
                        ditem[yVarName] = chartData[i][yVarName];
                        ditem["caption"] = chartData[i][xVarName].substring(0, 22);
                        ditem["title"] = chartData[i][xVarName];
                        ditem["op"] = 1.0 - parseFloat("0." + (result.length));
                        result.push(ditem);

                        resultColors[counter] = opts[0].color[0][chartData[i][opts[0].xaxis]];

                        counter += 1;
                    }
                }
            }
        }
        else {
            xVarName = opts[0].xaxis;

            for (var i in chartData) {
                hasMatch = false;
                for (var index = 0; index < result.length; ++index) {
                    var data = result[index];

                    if (data[xVarName] == chartData[i][xVarName]) {
                        result[index][yVarName] = result[index][yVarName] + chartData[i][yVarName];
                        hasMatch = true;
                        break;
                    }
                }
                if (hasMatch == false) {
                    ditem = {};
                    ditem[xVarName] = chartData[i][xVarName];
                    ditem[yVarName] = chartData[i][yVarName];
                    ditem["caption"] = opts[0].captions != undefined ? opts[0].captions[0][chartData[i][xVarName]] : "";
                    ditem["title"] = opts[0].captions != undefined ? opts[0].captions[0][chartData[i][xVarName]] : "";
                    ditem["op"] = 1;
                    result.push(ditem);

                    resultColors[counter] = opts[0].color != undefined ? opts[0].color[0][chartData[i][xVarName]] : "";

                    counter += 1;
                }
            }
        }


        runningData = result;
        runningColors = resultColors;
        return;
    }


    var chartData = data
    chartOptions = [{
        "captions": [{ "Cardiovascular": "Cardiovascular",'Gastrointestinal' : 'Gastrointestinal', "Genitourinary": "Genitourinary","Hematology":"Hematology", "Metabolic/Endocrine":"Metabolic or Endocrine", "Musculoskeletal/Skin": "Musculoskeletal or Skin" ," Musculoskeletal or Skin":" Musculoskeletal/Skin" ,"Respiratory":"Respiratory" ,"Transplant":"Transplant","Trauma":"Trauma" }],
        "color": [{ "Cardiovascular": "#43A9C7",'Gastrointestinal' : "#43A9C7","Genitourinary": "#43A9C7","Hematology":"#43A9C7", "Metabolic/Endocrine":"#43A9C7", "Musculoskeletal/Skin": "#43A9C7" ,"Respiratory":"#43A9C7" ,"Transplant":"#43A9C7","Trauma":"#43A9C7" }],
        "xaxis": "Diagnosis",
        "xaxisl1": "apache_iv_condition",
        "yaxis": "num"
    }]
    }   
    </script>
    <script>// gauge chart</script>
    <script>
        function guage(data) {
            d3.select("#svg").remove();

            var $container = d3.select('#svg4');
            var width = parseFloat(window.innerWidth * 0.27);
            var height = parseFloat(30);

            window.onresize = resize;

            function resize() {
                $container = d3.select('#svg4');
                width = parseFloat(window.innerWidth * 0.27);
                height = parseFloat(30);


                chart_w = width;
                resultPos = chart_w * result;

                text_margins = { top: chart_y_pos + gauge_h + 35, right: 10, bottom: 0, left: 110 };


                d3.select("line")
                    .attr("x1", resultPos)
                    .attr("y1", chart_y_pos)
                    .attr("x2", resultPos)
                    .attr("y2", gauge_h + chart_y_pos);

                d3.select("circle")
                    .attr("cx", resultPos)
                    .attr("cy", (gauge_h + chart_y_pos) / 2 + 100);

                d3.select(".rightLabel")
                    .attr("x", chart_w)
                    .text("width: " + width);

                d3.select(".rightPrcnt")
                    .attr("x", chart_w);

            }


            // Tick mark

            var LF = 30;

            var gauge_h = 30;

            var chart_w = width;
            var chart_y_pos = 200;

            var result = data;	// in a scale [0 1]
            var resultPos = chart_w * result;

            var text_margins = { top: chart_y_pos + gauge_h + 13, right: 10, bottom: 0, left: 110 };

            // Chart size -----------

            var svg = d3.select('#svg4')
                .append("g")
                .attr("width", '50%')
                .attr("height", '100%')
                .attr("id", "svgss");

            var gradient = svg.append("svg:defs")
                .append("svg:linearGradient")
                .attr("id", "gradient")
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "0%")
                .attr("spreadMethod", "pad");

            gradient.append("svg:stop")
                .attr("offset", "0%")
                .attr("stop-color", "#87F2F6")
                .attr("stop-opacity", 1);

            gradient.append("svg:stop")
                .attr("offset", "50%")
                .attr("stop-color", "#43A9C7")
                .attr("stop-opacity", 1);


            gradient.append("svg:stop")
                .attr("offset", "100%")
                .attr("stop-color", "#277EBF")
                .attr("stop-opacity", 1);

            svg.append("g")
                .append("rect")
                .attr("x", 20)
                .attr("y", chart_y_pos)
                .attr("width", "85%")
                .attr("height", gauge_h)
                .style("fill", "url(#gradient)");


            /****************************************
            * Text, titles
            *****************************************/

            // Left percentage indicator
            svg.append("g")
                .append("text")
                .attr("x", width * 0 + 16)
                .attr("y", text_margins.top)
                .style("font-size", 12)
                .style('fill', '#4B4C47')
                .style("text-anchor", "center")
                .text(0)



            // Right percentage indicator

            svg.append("g")
                .append("text")
                .attr("x", width * 1 + 18)
                .attr("y", text_margins.top)
                .style("font-size", 12)
                .style('fill', '#4B4C47')
                .style("text-anchor", "center")
                .text(100);


            svg.append("g")
                .append("text")
                .attr("x", width * 0.4 + 16)
                .attr("y", text_margins.top)
                .style("font-size", 12)
                .style('fill', '#4B4C47')
                .style("text-anchor", "center")
                .text(40);

            svg.append("g")
                .append("text")
                .attr("x", width * 0.2 + 16)
                .attr("y", text_margins.top)
                .style("font-size", 12)
                .style('fill', '#4B4C47')
                .style("text-anchor", "center")
                .text(20);


            svg.append("g")
                .append("text")
                .attr("x", width * 0.6 + 16)
                .attr("y", text_margins.top)
                .style("font-size", 12)
                .style('fill', '#4B4C47')
                .style("text-anchor", "center")
                .text(60);

            svg.append("g")
                .append("text")
                .attr("x", width * 0.8 + 16)
                .attr("y", text_margins.top)
                .style("font-size", 12)
                .style('fill', '#4B4C47')
                .style("text-anchor", "center")
                .text(80);

            svg.append("g")
                .append("text")
                .attr("x", width * 0.23)
                .attr("y", text_margins.top + 12)
                .style("font-size", 12)
                .style('fill', '#4B4C47')
                .text("0 = poor quality of life \u00A0 \u00A0 100 = high quality of life");


            /****************************************
            * Result
            *****************************************/


            var tickMark = svg.append("g");

            tickMark.append("line")
                .attr("x1", resultPos + 23)
                .attr("y1", chart_y_pos)
                .attr("x2", resultPos + 23)
                .attr("y2", gauge_h + chart_y_pos)
                .attr("stroke-width", 3)
                .attr("stroke", "#4B4C47");


            tickMark.append("circle")
                .attr("cx", resultPos + 23)
                .attr("cy", (gauge_h + chart_y_pos) / 2 + 100)
                .attr("r", 10)
                .attr('fill', '#4B4C47');



        }
    </script>

    <style>
        /* Planned/Unplanned legend */
        .nonpost {
            list-style: none;
            position: absolute;
            top: 35vh;
            left: 13vw;
        }

        .nonpost li {
            margin-right: 25px;
        }

        .nonpost span {
            border: 1px solid #ccc;
            float: left;
            width: 12px;
            height: 12px;
            margin: 2px;
        }

        .nonpost .non_operative {
            background-color: #5EDBDF;
        }

        .nonpost .post_operative {
            background-color: #43A9C7;
        }

        /* discharge status legend */
        .legend {
            list-style: none;
            position: absolute;
            top: 27vh;
            left: 75.5vw;
        }
        .legend li {
            float: left;
            margin-right: 25px;
            }
        .legend span {
                border: 1px solid #ccc;
                float: left;
                width: 12px;
                height: 12px;
                margin: 2px;
                }
        /* your colors */
        .legend .alive { background-color: #5EDBDF; }
        .legend .dead { background-color: #43A9C7; }


        /* body style */

        h3 {
            margin-bottom: 0.4vh;
            margin-left: 3vw;
            margin-top: 0.4vh;
            text-align: center;
            color: #36454f;

        }

        p {
            color: #36454f
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: white;
            margin-right: 0;
            margin-left: 0;
            margin-bottom: 0;
            width: 98vw;

        }


        #logo {
            position: absolute;
            left: 1vw;
            top: 7vh;
            width: 10vw;
        }

        #iris {
            position: absolute;
            left: 89vw;
            top: 7vh;
            width: 9vw;
        }


        .flex-child {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            align-items: center;
            align-content: space-between;
            justify-content: center;
            position: absolute;
            top: 5.2vh;
            left: 11vw;
            right: 11vw;
            width: 78vw;
            height: 14vh;
            background-color: white;
        }


        #svg1 {
            position: absolute;
            top: 20.3vh;
            height: 77.7vh;
            width: 32.4vw;
            left: 1vw;
            background-color: #f6f6f6;

        }

        #svg2 {
            position: absolute;
            top: 20.3vh;
            height: 77.7vh;
            width: 32.4vw;
            left: 33.8vw;
            background-color: #f6f6f6;
            justify-content: center;

        }

        #svg3 {
            position: absolute;
            top: 20.3vh;
            height: 35.8vh;
            width: 32.4vw;
            left: 66.6vw;
            background-color: #f6f6f6;

        }

        #svg4 {
            position: absolute;
            top: 57.2vh;
            height: 40.8vh;
            width: 32.4vw;
            left: 66.6vw;
            background-color: #f6f6f6;
        }

        #svg5 {
            height: 13vh;
            width: 18vw;
            margin-left: 0.9vw;
            margin-top: 0vh;
            margin-bottom: 0.4vh;
            background-color: #43A9C7;
        }

        #svg6 {
            height: 13vh;
            width: 18vw;
            margin-left: 0.9vw;
            margin-top: 0vh;
            margin-bottom: 0.4vh;
            background-color: #43A9C7;
        }

        #svg7 {
            height: 13vh;
            width: 18vw;
            margin-left: 0.9vw;
            margin-top: 0vh;
            margin-bottom: 0.4vh;
            background-color: #43A9C7;
        }

        #svg8 {
            height: 13vh;
            width: 18vw;
            margin-left: 0.9vw;
            margin-top: 0vh;
            margin-bottom: 0.4vh;
            background-color: #43A9C7;
        }

        #anti {
            position: absolute;
            height: 64vh;
            width: 50vw;
            left: 25vw;
            right: 25vw;
            top: 18vh;
            bottom: 18vh;
            background-color: #f6f6f6;
            opacity: 0;
        }

        

        /* Not stacked bar chart stlye*/
        .axis line,

        .axis path {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }


        .bar {
            fill: #43A9C7;
        }

        #filter1{
            position:  absolute;
            top: 1vh;
            left: 40vw;
        }

        #chart text {
        fill: black;
        font: 10px sans-serif;
        text-anchor: center;
    }

    #chart .axis text {
        font: 10px sans-serif;
    }

    #chart .axis path, .axis line {
        fill: none;
        /*stroke: #fff;*/
        shape-rendering: crispEdges;
    }

    #md{
        opacity: 0;
    }

    #ms{
        opacity: 1;
    }

    #button2{
        opacity: 0;
        position: absolute ;
        left: 28.5vw;
        top: 65vh;
    }



    </style>




</body>

</html>